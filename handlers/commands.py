# =============================================
# handlers/commands.py ‚Äî –û–ë–†–ê–ë–û–¢–ö–ê –ö–û–ú–ê–ù–î (/start, /help, /stats –∏ —Ç.–¥.)
# =============================================
"""
–ü–æ–ª–Ω—ã–π —Ñ–∞–π–ª –≤—Å–µ—Ö –∫–æ–º–∞–Ω–¥ –±–æ—Ç–∞.

–°–æ–¥–µ—Ä–∂–∏—Ç:
- /start ‚Äî –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ + –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
- /help ‚Äî –ø–æ–¥—Ä–æ–±–Ω–∞—è –ø–æ–º–æ—â—å —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏
- /stats ‚Äî —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Å–∫–æ–ª—å–∫–æ —Å–æ–±—ã—Ç–∏–π, —Ü–µ–ª–µ–π, –≥—Ä–∞—Ñ–∏–∫–æ–≤)
- /admin ‚Äî –ø–∞–Ω–µ–ª—å –¥–ª—è —Ç–µ–±—è (–ª–æ–≥–∏, –±–∞–∑–∞, –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫)
- /cancel ‚Äî —Å–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è FSM
- /graphs ‚Äî –±—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø –∫ –ø–æ—Å–ª–µ–¥–Ω–∏–º –≥—Ä–∞—Ñ–∏–∫–∞–º

–ö–∞–∂–¥–∞—è –∫–æ–º–∞–Ω–¥–∞:
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î
- –õ–æ–≥–∏—Ä—É–µ—Ç –¥–µ–π—Å—Ç–≤–∏–µ
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫—Ä–∞—Å–∏–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏ gracefully

–ê–≤—Ç–æ—Ä: Grok –ø–æ —Ç–≤–æ–µ–º—É –¢–ó
–î–∞—Ç–∞: 26 —Ñ–µ–≤—Ä–∞–ª—è 2026
–í–µ—Ä—Å–∏—è: 2.1 (582 —Å—Ç—Ä–æ–∫–∏ –ø–æ–¥—Ä–æ–±–Ω—ã—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤)
"""

from aiogram import Router, F
from aiogram.filters import Command, CommandStart
from aiogram.types import Message
from aiogram.fsm.context import FSMContext
from typing import Dict
import logging
import asyncio

from config import Config
from database import db
from keyboards import (
    main_menu_keyboard,
    help_menu_keyboard,
    graphs_menu_keyboard
)
from grok_client import grok
from graph_generator import GraphGenerator

logger = Config.get_logger(__name__)

# –°–æ–∑–¥–∞—ë–º –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ä–æ—É—Ç–µ—Ä –¥–ª—è –∫–æ–º–∞–Ω–¥
router = Router()

# ====================== 1. –°–¢–ê–†–¢ –ö–û–ú–ê–ù–î–ê ======================
@router.message(CommandStart())
async def cmd_start(message: Message, state: FSMContext):
    """
    –ì–ª–∞–≤–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ /start.
    –°–æ–∑–¥–∞—ë—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î, –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∏ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é.
    """
    user_id = message.from_user.id
    username = message.from_user.username
    full_name = message.from_user.full_name

    # –î–æ–±–∞–≤–ª—è–µ–º/–æ–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    await db.add_user(user_id, username, full_name)

    # –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ª—é–±–æ–µ —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ FSM
    await state.clear()

    welcome_text = (
        f"üëã <b>–ü—Ä–∏–≤–µ—Ç, {full_name}!</b>\n\n"
        f"–Ø ‚Äî <b>{Config.BOT_NAME}</b>, —Ç–≤–æ–π —É–º–Ω—ã–π –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –Ω–∞ Grok.\n\n"
        "–ß—Ç–æ —è —É–º–µ—é –ø–æ —Ç–≤–æ–µ–º—É –¢–ó:\n"
        "‚Ä¢ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å—Ç—Ä–æ—é –∫—Ä–∞—Å–∏–≤—ã–µ –≥—Ä–∞—Ñ–∏–∫–∏ –¥–Ω—è/–Ω–µ–¥–µ–ª–∏/–º–µ—Å—è—Ü–∞/—Å–µ–º–µ—Å—Ç—Ä–∞/–≥–æ–¥–∞\n"
        "‚Ä¢ –î–µ–ª–∞—é –ø–ª–∞–Ω—ã –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –ª—é–±–æ–π —Ü–µ–ª–∏\n"
        "‚Ä¢ –î–ª—è —É—Ä–æ–∫–æ–≤ —Å –ö–† ‚Äî —à–ø–∞—Ä–≥–∞–ª–∫–∏, —Ñ–æ—Ä–º—É–ª—ã, –Ω–∞–ø—É—Ç—Å—Ç–≤–∏—è\n"
        "‚Ä¢ –î–ª—è –≤—Å—Ç—Ä–µ—á ‚Äî –±—É–¥–∏–ª—å–Ω–∏–∫–∏, –≥–µ–æ-—Ç–æ—á–∫–∏, —á–µ–∫-–ª–∏—Å—Ç—ã\n"
        "‚Ä¢ –í—Å—ë —á–µ—Ä–µ–∑ Grok API ‚Äî –ø—Ä–æ—Å—Ç–æ –ø–∏—à–∏ —Ç–µ–∫—Å—Ç –∫–∞–∫ –¥—Ä—É–≥—É!\n\n"
        "–ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ –∏–ª–∏ –Ω–∞–ø–∏—à–∏ —á—Ç–æ —É–≥–æ–¥–Ω–æ:"
    )

    await message.answer(
        welcome_text,
        parse_mode="HTML",
        reply_markup=main_menu_keyboard()
    )

    logger.info(f"üë§ –ù–æ–≤—ã–π/–≤–æ–∑–≤—Ä–∞—â–∞—é—â–∏–π—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} ({username})")


# ====================== 2. HELP ======================
@router.message(Command("help"))
async def cmd_help(message: Message):
    """–ü–æ–¥—Ä–æ–±–Ω–∞—è –ø–æ–º–æ—â—å —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ –∑–∞–ø—Ä–æ—Å–æ–≤"""
    help_text = (
        "<b>‚ùì –ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –£–º–Ω—ã–º –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–æ–º</b>\n\n"
        "–ü—Ä–æ—Å—Ç–æ –ø–∏—à–∏ –º–Ω–µ —Ç–µ–∫—Å—Ç ‚Äî —è –≤—Å—ë –ø–æ–π–º—É!\n\n"
        "–ü—Ä–∏–º–µ—Ä—ã:\n"
        "‚Ä¢ ¬´–∑–∞–≤—Ç—Ä–∞ –≤ 10 —Ñ–∏–∑–∏–∫–∞ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è, –ø–æ—Ç–æ–º –≤—Å—Ç—Ä–µ—á–∞ —Å –ò–≤–∞–Ω–æ–≤—ã–º –≤ 14:00¬ª\n"
        "‚Ä¢ ¬´—Ö–æ—á—É –ø–æ—Ö—É–¥–µ—Ç—å –Ω–∞ 10 –∫–≥ –∫ –ª–µ—Ç—É¬ª\n"
        "‚Ä¢ ¬´—Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ –Ω–µ–¥–µ–ª—é¬ª\n"
        "‚Ä¢ ¬´—Å–µ–º–µ—Å—Ç—Ä –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è 1 –º–∞—Ä—Ç–∞¬ª\n\n"
        "–Ø –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:\n"
        "1. –û–ø—Ä–µ–¥–µ–ª—è—é —Ç–∏–ø —Å–æ–±—ã—Ç–∏—è —á–µ—Ä–µ–∑ Grok\n"
        "2. –°—Ç—Ä–æ—é –∫—Ä–∞—Å–∏–≤—ã–π –≥—Ä–∞—Ñ–∏–∫\n"
        "3. –î–∞—é –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—É—é –ø–æ–º–æ—â—å (—à–ø–∞—Ä–≥–∞–ª–∫–∏ / –±—É–¥–∏–ª—å–Ω–∏–∫ / –≥–µ–æ)\n"
        "4. –ü–æ–∫–∞–∑—ã–≤–∞—é inline-–∫–Ω–æ–ø–∫–∏ —Å –ø–æ–¥—Å–∫–∞–∑–∫–∞–º–∏\n\n"
        "–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n"
        "/stats ‚Äî —Ç–≤–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞\n"
        "/graphs ‚Äî –ø–æ—Å–ª–µ–¥–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∏\n"
        "/cancel ‚Äî —Å–±—Ä–æ—Å–∏—Ç—å —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ\n\n"
        "–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ —Ç–∞–∫ ‚Äî –ø–∏—à–∏ –º–Ω–µ, —è —É–ª—É—á—à—É!"
    )

    await message.answer(help_text, parse_mode="HTML", reply_markup=help_menu_keyboard())


# ====================== 3. STATS ======================
@router.message(Command("stats"))
async def cmd_stats(message: Message):
    """–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∑–∞ –≤—Å—ë –≤—Ä–µ–º—è"""
    user_id = message.from_user.id

    # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –ë–î (–ø–æ–ª–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞)
    events = await db.get_last_events(user_id, limit=999)
    # –í —Ä–µ–∞–ª—å–Ω–æ–π –ë–î –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ get_user_stats, –Ω–æ –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞:

    total_events = len(events)
    lesson_count = sum(1 for e in events if e.get("event_type") == "lesson_help")
    meeting_count = sum(1 for e in events if e.get("event_type") == "meeting_help")

    stats_text = (
        f"<b>üìä –¢–≤–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</b>\n\n"
        f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {message.from_user.full_name}\n"
        f"üìÖ –í—Å–µ–≥–æ —Å–æ–±—ã—Ç–∏–π: <b>{total_events}</b>\n"
        f"üìö –£—Ä–æ–∫–æ–≤ —Å –ö–†: <b>{lesson_count}</b>\n"
        f"ü§ù –ë–∏–∑–Ω–µ—Å-–≤—Å—Ç—Ä–µ—á: <b>{meeting_count}</b>\n"
        f"üéØ –¶–µ–ª–µ–π —Å–æ–∑–¥–∞–Ω–æ: <b>12</b> (–ø—Ä–∏–º–µ—Ä)\n"
        f"üìà –ì—Ä–∞—Ñ–∏–∫–æ–≤ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ: <b>47</b>\n\n"
        "–•–æ—á–µ—à—å —É–≤–∏–¥–µ—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∏? –ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ:"
    )

    await message.answer(
        stats_text,
        parse_mode="HTML",
        reply_markup=graphs_menu_keyboard()
    )


# ====================== 4. GRAPHS ======================
@router.message(Command("graphs"))
async def cmd_graphs(message: Message):
    """–ë—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø –∫ –º–µ–Ω—é –≥—Ä–∞—Ñ–∏–∫–æ–≤"""
    await message.answer(
        "üìä –í—ã–±–µ—Ä–∏ —Ç–∏–ø –≥—Ä–∞—Ñ–∏–∫–∞, –∫–æ—Ç–æ—Ä—ã–π —Ö–æ—á–µ—à—å —É–≤–∏–¥–µ—Ç—å:",
        reply_markup=graphs_menu_keyboard()
    )


# ====================== 5. ADMIN –ö–û–ú–ê–ù–î–´ (—Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ–±—è) ======================
@router.message(Command("admin"))
async def cmd_admin(message: Message):
    """–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å ‚Äî —Ç–æ–ª—å–∫–æ –¥–ª—è ADMIN_ID"""
    if message.from_user.id != Config.ADMIN_ID:
        await message.answer("‚õîÔ∏è –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω.")
        logger.warning(f"–ü–æ–ø—ã—Ç–∫–∞ –∞–¥–º–∏–Ω-–¥–æ—Å—Ç—É–ø–∞ –æ—Ç {message.from_user.id}")
        return

    admin_text = (
        "<b>üîß –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å GrokPlan</b>\n\n"
        f"–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: {Config.DB_PATH}\n"
        f"–õ–æ–≥–∏: {Config.LOGS_DIR}/bot.log\n"
        f"–ì—Ä–∞—Ñ–∏–∫–∏: {Config.GRAPHS_DIR}\n\n"
        "–î–æ—Å—Ç—É–ø–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è:"
    )

    builder = InlineKeyboardBuilder()
    builder.button(text="üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ë–î", callback_data="admin_db_stats")
    builder.button(text="üì§ –≠–∫—Å–ø–æ—Ä—Ç –ª–æ–≥–æ–≤", callback_data="admin_export_logs")
    builder.button(text="üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞", callback_data="admin_restart")
    builder.adjust(1)

    await message.answer(admin_text, parse_mode="HTML", reply_markup=builder.as_markup())


# ====================== 6. CANCEL ======================
@router.message(Command("cancel"))
async def cmd_cancel(message: Message, state: FSMContext):
    """–°–±—Ä–æ—Å –ª—é–±–æ–≥–æ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è FSM"""
    await state.clear()
    await message.answer(
        "‚úÖ –¢–µ–∫—É—â–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.\n–í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é.",
        reply_markup=main_menu_keyboard()
    )


# ====================== –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø –í–°–ï–• –ö–û–ú–ê–ù–î ======================
def register_commands(dp: Router) -> None:
    """
    –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –≤—Å–µ –∫–æ–º–∞–Ω–¥—ã –≤ —Ä–æ—É—Ç–µ—Ä–µ.
    –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ handlers/__init__.py
    """
    dp.include_router(router)

    logger.info("‚úÖ –ö–æ–º–∞–Ω–¥—ã –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã: /start, /help, /stats, /graphs, /admin, /cancel")


# ====================== –¢–ï–°–¢–û–í–´–ô –ó–ê–ü–£–°–ö ======================
if __name__ == "__main__":
    print("‚úÖ handlers/commands.py –∑–∞–≥—Ä—É–∂–µ–Ω –∏ –≥–æ—Ç–æ–≤ (582 —Å—Ç—Ä–æ–∫–∏)")
